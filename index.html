<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Sharing your method with R(cpp)</title>
    <meta charset="utf-8" />
    <meta name="author" content="Byron C Jaeger" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <link href="libs/xaringanExtra-banner/banner.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-banner/banner.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Sharing your method with R(cpp)
## Four guidelines for faster code
### Byron C Jaeger
### Wake Forest University School of Medicine
### 2022/08/08 (updated: 2022-07-31)

---

class: center, middle







<script>document.addEventListener('DOMContentLoaded',function(){new xeBanner(JSON.parse('{"left":"Sharing methods with R(cpp)","right":"Byron C Jaeger","exclude":["inverse"],"position":"top"}'))})</script>
<script>document.addEventListener('DOMContentLoaded',function(){new xeBanner(JSON.parse('{"left":"https://bcjaeger.github.io/seminar-fastpack/","exclude":["inverse"],"position":"bottom"}'))})</script>


# Background

---
## obliqueRSF

In 2019, I made `obliqueRSF`, an R package to fit random survival forests using oblique recursive partitioning.

--

`obliqueRSF` had higher prediction accuracy versus:

- `randomForestSRC`, 

- `ranger`,

- `party`. 

- but was also hundreds of times slower.

---
class: center, middle
background-image: url("img/meme_slow_R.jpg")
background-size: contain

---

&lt;img src="img/aorsf-bench-time_1.png" width="90%" /&gt;

---

&lt;img src="img/aorsf-bench-time_2.png" width="90%" /&gt;


---
class: center, middle, inverse

# Four guidelines for faster code 

---
class: center, middle

# 1. Always be benchmarking

---
## Why benchmark?

- it gives you data on how fast your code runs

--

- it encourages you to write more modular functions (a good thing)


---
## How to benchmark?

__Step 1. Define a task:__ Count events per group (status of 1 `\(\Rightarrow\)` event, 3 groups)


```r
# status = c(1, 0, 1, ...)
status = sample(x = c(0L, 1L), size = 1e5, replace = TRUE)

# group = c(2, 0, 1, ...)
group = sample(x = c(0L, 1L, 2L), size = 1e5, replace = TRUE)
```

--

__Step 2. Define the reference competitors__


```r
# competitors: table() and tapply()
table(status, group)[2, ] 
```

```
##     0     1     2 
## 16690 16751 16688
```

```r
tapply(status, group, FUN = sum)
```

```
##     0     1     2 
## 16690 16751 16688
```

---

## How to benchmark?

__Step 2 contd.__ Enter your own competitor(s)!

&lt;img src="ink/vecs_1.png" width="2063" /&gt;

---

## How to benchmark?

__Step 2 contd.__ Enter your own competitor(s)!

&lt;img src="ink/vecs_2.png" width="2063" /&gt;

---

## How to benchmark?

__Step 2 contd.__ Enter your own competitor(s)!

&lt;img src="ink/vecs_3.png" width="2063" /&gt;


---

## How to benchmark?

__Step 2 contd.__ Enter your own competitor(s)!

&lt;img src="ink/vecs_4.png" width="2063" /&gt;


---

## How to benchmark?

__Step 2 contd.__ Enter your own competitor(s)!


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector rcpp_count_dbl(NumericVector status,
                             NumericVector group) {
 
 NumericVector group_uni = sort_unique(group);
 NumericVector out(group_uni.length());
 
 for( int i = 0; i &lt; group_uni.length(); i++ ){
  for( int j = 0; j &lt; group.length(); j++ ){
   if(group[j] == group_uni[i]) out[i] += status[j];
  }
 }
 
 return(out);
 
}

```

---

## How to benchmark?

__Step 2 contd.__ Enter your own competitor(s)!


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
IntegerVector rcpp_count_int(IntegerVector status,
                             IntegerVector group) {
 
 IntegerVector group_uni = sort_unique(group);
 IntegerVector out(group_uni.length());
 
 for( int i = 0; i &lt; group_uni.length(); i++ ){
  for( int j = 0; j &lt; group.length(); j++ ){
   if(group[j] == group_uni[i]) out[i] += status[j];
  }
 }
 
 return(out);
 
}

```

---

## How to benchmark?

__Step 3. Off to the races:__


```r
library(microbenchmark)
microbenchmark(table = table(status, group)[2, ],
               tapply = tapply(status, group, FUN = sum),
               rcpp_count_dbl = rcpp_count_dbl(status, group),
               rcpp_count_int = rcpp_count_int(status, group))
```

--

<div id="zrlamounav" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#zrlamounav .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zrlamounav .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zrlamounav .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zrlamounav .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zrlamounav .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zrlamounav .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zrlamounav .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zrlamounav .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zrlamounav .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zrlamounav .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zrlamounav .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zrlamounav .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#zrlamounav .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zrlamounav .gt_from_md > :first-child {
  margin-top: 0;
}

#zrlamounav .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zrlamounav .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zrlamounav .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zrlamounav .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zrlamounav .gt_row_group_first td {
  border-top-width: 2px;
}

#zrlamounav .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zrlamounav .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zrlamounav .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zrlamounav .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zrlamounav .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zrlamounav .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zrlamounav .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zrlamounav .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zrlamounav .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zrlamounav .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zrlamounav .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zrlamounav .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zrlamounav .gt_left {
  text-align: left;
}

#zrlamounav .gt_center {
  text-align: center;
}

#zrlamounav .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zrlamounav .gt_font_normal {
  font-weight: normal;
}

#zrlamounav .gt_font_bold {
  font-weight: bold;
}

#zrlamounav .gt_font_italic {
  font-style: italic;
}

#zrlamounav .gt_super {
  font-size: 65%;
}

#zrlamounav .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#zrlamounav .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#zrlamounav .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zrlamounav .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#zrlamounav .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#zrlamounav .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="7" class="gt_heading gt_title gt_font_normal" style>Benchmark demonstration: counting events in groups</th>
    </tr>
    <tr>
      <th colspan="7" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style>table(), tapply(), and Rcpp functions</th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1">Function</th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="6">
        <span class="gt_column_spanner">Time, milliseconds</span>
      </th>
    </tr>
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Minimum</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">25th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Median</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">75th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Maximum</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right gt_stub">table</td>
<td class="gt_row gt_center">5.2</td>
<td class="gt_row gt_center">6.2</td>
<td class="gt_row gt_center">8.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">6.4</td>
<td class="gt_row gt_center">7.0</td>
<td class="gt_row gt_center">79</td></tr>
    <tr><td class="gt_row gt_right gt_stub">tapply</td>
<td class="gt_row gt_center">2.2</td>
<td class="gt_row gt_center">2.6</td>
<td class="gt_row gt_center">3.4</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">2.6</td>
<td class="gt_row gt_center">2.7</td>
<td class="gt_row gt_center">80</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_dbl</td>
<td class="gt_row gt_center">1.7</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">2.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.9</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">10</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_int</td>
<td class="gt_row gt_center">1.4</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">2.2</td></tr>
  </tbody>
  
  
</table>
</div>


---
class: center, middle

# 2. Trace your data

---
## What do you mean by trace?

Tracing your data means being notified when 

- your data are copied

--

- your data are cast to a different type

--

## So, why trace?

Copying and casting require additional memory, slowing down your code.

---
## How to trace?


```r
data &lt;- data.frame(x = 1:10)

tracemem(data)
```

```
## [1] "&lt;0000000022003AD8&gt;"
```

No copies here


```r
# as of R 4.0, `data_2` and `data` share memory
data_2 &lt;- data
```

---
## How to trace?

that is, until `data_2` is modified: 


```r
data_2$x[1] &lt;- 10
```

```
## tracemem[0x0000000022003ad8 -&gt; 0x0000000022409060]: eval eval eval_with_user_handlers withVisible withCallingHandlers handle timing_fn evaluate_call &lt;Anonymous&gt; evaluate in_dir in_input_dir eng_r block_exec call_block process_group.block process_group withCallingHandlers process_file &lt;Anonymous&gt; &lt;Anonymous&gt; 
## tracemem[0x0000000022409060 -&gt; 0x0000000022408f10]: $&lt;-.data.frame $&lt;- eval eval eval_with_user_handlers withVisible withCallingHandlers handle timing_fn evaluate_call &lt;Anonymous&gt; evaluate in_dir in_input_dir eng_r block_exec call_block process_group.block process_group withCallingHandlers process_file &lt;Anonymous&gt; &lt;Anonymous&gt;
```

Yikes! Not just one, but _two_ memory messages

--

- `data_2` is no longer the same as `data`, so they can't share memory

--

- R assumes `10` is a double,&lt;sup&gt;1&lt;/sup&gt; so `x` is cast from an integer double.


```r
# PS: don't forget to untrace
untracemem(data)
```

.footnote[
1. R also assumes `1:10` is integer valued, so `x` was originally created as an integer vector.
]

---
## So, who's copying data?


```r
tracemem(status)
```

```
## [1] "&lt;00007FF4FD850010&gt;"
```

```r
tracemem(group)
```

```
## [1] "&lt;00007FF4FD770010&gt;"
```

---
## So, who's copying data?

`table` makes no copies


```r
table(status, group)
```

```
##       group
## status     0     1     2
##      0 16633 16604 16634
##      1 16690 16751 16688
```


---
## So, who's copying data?

`tapply` copies the `group` data


```r
tapply(status, group, sum)
```

```
## tracemem[0x00007ff4fd770010 -&gt; 0x00007ff4fcae0010]: FUN lapply tapply eval eval eval_with_user_handlers withVisible withCallingHandlers handle timing_fn evaluate_call &lt;Anonymous&gt; evaluate in_dir in_input_dir eng_r block_exec call_block process_group.block process_group withCallingHandlers process_file &lt;Anonymous&gt; &lt;Anonymous&gt;
```

```
##     0     1     2 
## 16690 16751 16688
```

---
## So, who's copying data?

`rcpp_count_dbl` casts both vectors from integer to double


```r
rcpp_count_dbl(status, group, n_groups = 3)
```

```
## tracemem[0x00007ff4fd770010 -&gt; 0x00007ff4fc8c0010]: .Call rcpp_count_dbl eval eval eval_with_user_handlers withVisible withCallingHandlers handle timing_fn evaluate_call &lt;Anonymous&gt; evaluate in_dir in_input_dir eng_r block_exec call_block process_group.block process_group withCallingHandlers process_file &lt;Anonymous&gt; &lt;Anonymous&gt; 
## tracemem[0x00007ff4fd850010 -&gt; 0x00007ff4fc7f0010]: .Call rcpp_count_dbl eval eval eval_with_user_handlers withVisible withCallingHandlers handle timing_fn evaluate_call &lt;Anonymous&gt; evaluate in_dir in_input_dir eng_r block_exec call_block process_group.block process_group withCallingHandlers process_file &lt;Anonymous&gt; &lt;Anonymous&gt;
```

```
## [1] 16690 16751 16688
```

---
## So, who's copying data?

`rcpp_count_int` makes no copies


```r
rcpp_count_int(status, group, n_groups = 3)
```

```
## [1] 16690 16751 16688
```

---

## This makes more sense now

<div id="umogfopnrr" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#umogfopnrr .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#umogfopnrr .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#umogfopnrr .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#umogfopnrr .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#umogfopnrr .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#umogfopnrr .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#umogfopnrr .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#umogfopnrr .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#umogfopnrr .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#umogfopnrr .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#umogfopnrr .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#umogfopnrr .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#umogfopnrr .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#umogfopnrr .gt_from_md > :first-child {
  margin-top: 0;
}

#umogfopnrr .gt_from_md > :last-child {
  margin-bottom: 0;
}

#umogfopnrr .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#umogfopnrr .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#umogfopnrr .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#umogfopnrr .gt_row_group_first td {
  border-top-width: 2px;
}

#umogfopnrr .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#umogfopnrr .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#umogfopnrr .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#umogfopnrr .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#umogfopnrr .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#umogfopnrr .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#umogfopnrr .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#umogfopnrr .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#umogfopnrr .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#umogfopnrr .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#umogfopnrr .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#umogfopnrr .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#umogfopnrr .gt_left {
  text-align: left;
}

#umogfopnrr .gt_center {
  text-align: center;
}

#umogfopnrr .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#umogfopnrr .gt_font_normal {
  font-weight: normal;
}

#umogfopnrr .gt_font_bold {
  font-weight: bold;
}

#umogfopnrr .gt_font_italic {
  font-style: italic;
}

#umogfopnrr .gt_super {
  font-size: 65%;
}

#umogfopnrr .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#umogfopnrr .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#umogfopnrr .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#umogfopnrr .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#umogfopnrr .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#umogfopnrr .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="7" class="gt_heading gt_title gt_font_normal" style>Benchmark demonstration: counting events in groups</th>
    </tr>
    <tr>
      <th colspan="7" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style>table(), tapply(), and Rcpp functions</th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1">Function</th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="6">
        <span class="gt_column_spanner">Time, milliseconds</span>
      </th>
    </tr>
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Minimum</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">25th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Median</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">75th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Maximum</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right gt_stub">table</td>
<td class="gt_row gt_center">5.2</td>
<td class="gt_row gt_center">6.2</td>
<td class="gt_row gt_center">8.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">6.4</td>
<td class="gt_row gt_center">7.0</td>
<td class="gt_row gt_center">79</td></tr>
    <tr><td class="gt_row gt_right gt_stub">tapply</td>
<td class="gt_row gt_center">2.2</td>
<td class="gt_row gt_center">2.6</td>
<td class="gt_row gt_center">3.4</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">2.6</td>
<td class="gt_row gt_center">2.7</td>
<td class="gt_row gt_center">80</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_dbl</td>
<td class="gt_row gt_center">1.7</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">2.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.9</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">10</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_int</td>
<td class="gt_row gt_center">1.4</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">2.2</td></tr>
  </tbody>
  
  
</table>
</div>

---
class: center, middle

# 3. Count your operations

---
## Why count operations?

Number of operations `\(\approx\)` computational cost of your code

## How to count

You don't have to be exact, just write the main ideas 

---
## Example

In our C++ function, we use `\(n\)` operations for each unique value in `group`, 

&lt;img src="ink/vecs_1.png" width="2063" /&gt;

---
## Example

In our C++ function, we use `\(n\)` operations for each unique value in `group`, 


&lt;img src="ink/vecs_2.png" width="2063" /&gt;

---
## Example

In our C++ function, we use `\(n\)` operations for each unique value in `group`, 

&lt;img src="ink/vecs_3.png" width="2063" /&gt;

---
## Example

In our C++ function, we use `\(n\)` operations for each unique value in `group`, 

&lt;img src="ink/vecs_4.png" width="2063" /&gt;

---
## Example

As `\(n, g \rightarrow \infty\)`, we use `\(\mathcal{O}(n \cdot g)\)` operations, where `\(g\)` = number of groups

Can we reduce the operation cost?

- Can't remove the sum, so we have at least `\(n\)` operations.

- Can we sum by group without finding group indices? That would drop `\(g\)` from our operation count

Yes, because the group indices are given to us by the group vector.

---
## 1 loop instead of 2

&lt;img src="ink/vecs_5.png" width="2263" /&gt;

---
## 1 loop instead of 2

&lt;img src="ink/vecs_6.png" width="2263" /&gt;

---
## 1 loop instead of 2

&lt;img src="ink/vecs_7.png" width="2263" /&gt;

---
## 1 loop instead of 2

&lt;img src="ink/vecs_8.png" width="2263" /&gt;

---
## 1 loop instead of 2

&lt;img src="ink/vecs_9.png" width="2263" /&gt;

---
## 1 loop instead of 2

<div id="kxrynhbaui" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#kxrynhbaui .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#kxrynhbaui .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kxrynhbaui .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#kxrynhbaui .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#kxrynhbaui .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kxrynhbaui .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kxrynhbaui .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#kxrynhbaui .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#kxrynhbaui .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#kxrynhbaui .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#kxrynhbaui .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#kxrynhbaui .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#kxrynhbaui .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#kxrynhbaui .gt_from_md > :first-child {
  margin-top: 0;
}

#kxrynhbaui .gt_from_md > :last-child {
  margin-bottom: 0;
}

#kxrynhbaui .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#kxrynhbaui .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#kxrynhbaui .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#kxrynhbaui .gt_row_group_first td {
  border-top-width: 2px;
}

#kxrynhbaui .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kxrynhbaui .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#kxrynhbaui .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#kxrynhbaui .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kxrynhbaui .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kxrynhbaui .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#kxrynhbaui .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#kxrynhbaui .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kxrynhbaui .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kxrynhbaui .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kxrynhbaui .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kxrynhbaui .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kxrynhbaui .gt_left {
  text-align: left;
}

#kxrynhbaui .gt_center {
  text-align: center;
}

#kxrynhbaui .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#kxrynhbaui .gt_font_normal {
  font-weight: normal;
}

#kxrynhbaui .gt_font_bold {
  font-weight: bold;
}

#kxrynhbaui .gt_font_italic {
  font-style: italic;
}

#kxrynhbaui .gt_super {
  font-size: 65%;
}

#kxrynhbaui .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#kxrynhbaui .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#kxrynhbaui .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#kxrynhbaui .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#kxrynhbaui .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#kxrynhbaui .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="7" class="gt_heading gt_title gt_font_normal" style>Benchmark demonstration: counting events in groups</th>
    </tr>
    <tr>
      <th colspan="7" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style>table(), tapply(), and Rcpp functions</th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1">Function</th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="6">
        <span class="gt_column_spanner">Time, milliseconds</span>
      </th>
    </tr>
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Minimum</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">25th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Median</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">75th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Maximum</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right gt_stub">table</td>
<td class="gt_row gt_center">5.2</td>
<td class="gt_row gt_center">6.2</td>
<td class="gt_row gt_center">8.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">6.4</td>
<td class="gt_row gt_center">7.0</td>
<td class="gt_row gt_center">79</td></tr>
    <tr><td class="gt_row gt_right gt_stub">tapply</td>
<td class="gt_row gt_center">2.2</td>
<td class="gt_row gt_center">2.6</td>
<td class="gt_row gt_center">3.4</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">2.6</td>
<td class="gt_row gt_center">2.7</td>
<td class="gt_row gt_center">80</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_dbl</td>
<td class="gt_row gt_center">1.7</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">2.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.9</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">10</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_int</td>
<td class="gt_row gt_center">1.4</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">2.2</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_1loop_int</td>
<td class="gt_row gt_center">0.19</td>
<td class="gt_row gt_center">0.19</td>
<td class="gt_row gt_center">0.21</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">0.20</td>
<td class="gt_row gt_center">0.22</td>
<td class="gt_row gt_center">0.94</td></tr>
  </tbody>
  
  
</table>
</div>


---
class: center, middle

# 4. Ride the Armadillo 

---

## Armadillo

(http://arma.sourceforge.net/)

&lt;iframe src="http://arma.sourceforge.net/" width="100%" height="400px" data-external="1"&gt;&lt;/iframe&gt;

---
## Armadillo

Faster memory access and low-level parallelization 

<div id="fisvmvzdtj" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#fisvmvzdtj .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#fisvmvzdtj .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fisvmvzdtj .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#fisvmvzdtj .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#fisvmvzdtj .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fisvmvzdtj .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fisvmvzdtj .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#fisvmvzdtj .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#fisvmvzdtj .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#fisvmvzdtj .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#fisvmvzdtj .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#fisvmvzdtj .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#fisvmvzdtj .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#fisvmvzdtj .gt_from_md > :first-child {
  margin-top: 0;
}

#fisvmvzdtj .gt_from_md > :last-child {
  margin-bottom: 0;
}

#fisvmvzdtj .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#fisvmvzdtj .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#fisvmvzdtj .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#fisvmvzdtj .gt_row_group_first td {
  border-top-width: 2px;
}

#fisvmvzdtj .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fisvmvzdtj .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#fisvmvzdtj .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#fisvmvzdtj .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fisvmvzdtj .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fisvmvzdtj .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#fisvmvzdtj .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#fisvmvzdtj .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fisvmvzdtj .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fisvmvzdtj .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fisvmvzdtj .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fisvmvzdtj .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fisvmvzdtj .gt_left {
  text-align: left;
}

#fisvmvzdtj .gt_center {
  text-align: center;
}

#fisvmvzdtj .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#fisvmvzdtj .gt_font_normal {
  font-weight: normal;
}

#fisvmvzdtj .gt_font_bold {
  font-weight: bold;
}

#fisvmvzdtj .gt_font_italic {
  font-style: italic;
}

#fisvmvzdtj .gt_super {
  font-size: 65%;
}

#fisvmvzdtj .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#fisvmvzdtj .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#fisvmvzdtj .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#fisvmvzdtj .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#fisvmvzdtj .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#fisvmvzdtj .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  <thead class="gt_header">
    <tr>
      <th colspan="7" class="gt_heading gt_title gt_font_normal" style>Benchmark demonstration: counting events in groups</th>
    </tr>
    <tr>
      <th colspan="7" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style>table(), tapply(), and Rcpp functions</th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1">Function</th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="6">
        <span class="gt_column_spanner">Time, milliseconds</span>
      </th>
    </tr>
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Minimum</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">25th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Median</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">75th %</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">Maximum</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_right gt_stub">table</td>
<td class="gt_row gt_center">5.2</td>
<td class="gt_row gt_center">6.2</td>
<td class="gt_row gt_center">8.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">6.4</td>
<td class="gt_row gt_center">7.0</td>
<td class="gt_row gt_center">79</td></tr>
    <tr><td class="gt_row gt_right gt_stub">tapply</td>
<td class="gt_row gt_center">2.2</td>
<td class="gt_row gt_center">2.6</td>
<td class="gt_row gt_center">3.4</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">2.6</td>
<td class="gt_row gt_center">2.7</td>
<td class="gt_row gt_center">80</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_dbl</td>
<td class="gt_row gt_center">1.7</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">2.1</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.9</td>
<td class="gt_row gt_center">1.9</td>
<td class="gt_row gt_center">10</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_int</td>
<td class="gt_row gt_center">1.4</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">1.5</td>
<td class="gt_row gt_center">1.5</td>
<td class="gt_row gt_center">2.2</td></tr>
    <tr><td class="gt_row gt_right gt_stub">rcpp_count_1loop_int</td>
<td class="gt_row gt_center">0.19</td>
<td class="gt_row gt_center">0.19</td>
<td class="gt_row gt_center">0.21</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">0.20</td>
<td class="gt_row gt_center">0.22</td>
<td class="gt_row gt_center">0.94</td></tr>
    <tr><td class="gt_row gt_right gt_stub">arma_count_1loop_int</td>
<td class="gt_row gt_center">0.07</td>
<td class="gt_row gt_center">0.07</td>
<td class="gt_row gt_center">0.08</td>
<td class="gt_row gt_center" style="background-color: #F9E3D6; font-style: italic;">0.08</td>
<td class="gt_row gt_center">0.08</td>
<td class="gt_row gt_center">1.1</td></tr>
  </tbody>
  
  
</table>
</div>

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
